<!DOCTYPE html>
<html>

<head></head>

<body>
	<style>
		#background{
			position: absolute;
			z-index: -2;
			padding: 0;
			background-image: url("imgs/mapa.png");
			background-repeat: no-repeat;
			background-position: center;
			background-size: 100%;
			width: 1600px;
			height: 950;
		}
		#mapa {
			position: relative;
			width: 100%;
			height: 100%;
		}

		#mapa td {
			width: 50px;
			height: 50px;
			z-index: 3;
			border-radius: 50%;
		}

		.linha {
			position: absolute;
			height: 2px;
			z-index: 1;
			background-color: blue;
			transform-origin: left;
		}
	</style>
	<div id="background">
	<table id="mapa"></table>
	<h2>CARALHOOOOOOOOOOOOOOOOOOOO!</h2>
	</div>
	<div id="caminho"></div>

	<form id="form">
		<label>Postes: </label><input name="postes" type="file" requiblack><br>
		<label>Conexoes: </label><input name="conexoes" type="file" requiblack><br>
		<input type="submit" accept=".json, .JSON" value="Gerar Grafo">
	</form>
</body>
<script src="js/errorhandler.js"></script>
<script>
	let form = document.getElementById("form");

	let divCaminho = document.getElementById("caminho");
	let mapa = document.getElementById("mapa");
	let postes, caminho, conexoes, id;
	let origem, destino, cellsCaminho;
	let conexoesCaminho;

	form.onsubmit = async function (e) {
		e.preventDefault();
		readFile(form.elements.namedItem("postes").files[0], true);
		readFile(form.elements.namedItem("conexoes").files[0], false);
	}

	function readFile(file, ehpostes) {
		var reader = new FileReader();
		if(ehpostes)
			reader.onload = onReaderLoadPostes;
		else
			reader.onload = onReaderLoadConexoes;
		reader.readAsText(file);
	}

	function onReaderLoadPostes(event) {
		inserirPostes(JSON.parse(event.target.result));
	}
	
	function onReaderLoadConexoes(event) {
		inserirConexoes(JSON.parse(event.target.result));
	}

	function inserirPostes(listaPostes) {
		makeRequest("POST", "", async function () {
			if (this.readyState == 4 && this.status == 200) {
				getPostes();
			} else {
				let rj = JSON.parse(this.responseText);
				errorHandler(rj);
			}
		}, listaPostes);
	}

	function inserirConexoes(listaConexoes) {
		makeRequest("POST", "/conexoes", async function () {
			if (this.readyState == 4 && this.status == 200) {
				getConexoes();
			} else {
				let rj = JSON.parse(this.responseText);
				errorHandler(rj);
			}
		}, listaConexoes);
	}
	//getPostes();
	//getMenorCaminho(6);

	createCells(19, 32);

	function conectCells() {
		for (let i = 0; i < conexoes.length; i++) {
			let ori = getCellCoordenada(conexoes[i].origem);
			let dest = getCellCoordenada(conexoes[i].destino);
			var p1 = {x: ori.offsetLeft, y: ori.offsetTop};
			var p2 = {x: dest.offsetLeft, y: dest.offsetTop};

			var a = p1.x - p2.x;
			var b = p1.y - p2.y;
			var length = Math.sqrt(a * a + b * b);

			var angleDeg = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;

			var pointWidth = ori.clientWidth / 2;
			var pointHeight = dest.clientWidth / 2;

			var line = createLine(conexoes[i].id);
			line.style.zIndex = "-1";
			mapa.style.zIndex = 0;
			line.style.width = length + 'px';
			line.style.left = (p1.x + pointWidth + 10) + 'px';
			line.style.top = (p1.y + pointHeight + 10) + 'px';

			line.style.transform = "rotate(" + angleDeg + "deg)";
			mapa.appendChild(line);
		}
	}

	function createLine(id) {
		let div = document.createElement("DIV");
		div.id = "conx" + id;
		div.className = "linha";
		return div;
	}

	function getPostePorId(id) {
		for (p in postes) {
			if (p.id == id)
				return p;
		}
	}

	function getCellCoordenada(poste) {
		return document.getElementById("cell" + poste.coordenadaX + "x" + poste.coordenadaY);;
	}

	function colorirCell() {
		for (let i = 0; i < postes.length; i++) {
			let p = postes[i];
			let cell = getCellCoordenada(p);
			if (cell) {
				cell.innerHTML = p.id;
				cell.setAttribute("posteId", postes[i].id);
				cell.onclick = function () {
					if (origem != p) {
						if (origem)
							getCellCoordenada(origem).style.backgroundColor = "black";
						origem = p;
					}
					cell.style.backgroundColor = "green";
					getMenorCaminho(p.id);
				}
				cell.style.backgroundColor = "black";
				cell.style.color = "white";
			}
		}
	}

	function createCells(lin, col) {
		for (let i = 1; i <= lin; i++) {
			let tr = document.createElement("TR");
			tr.id = "lin" + i;
			for (let j = 1; j <= col; j++) {
				let td = document.createElement("TD");
				td.id = "cell" + i + "x" + j;
				tr.appendChild(td);
			}
			mapa.appendChild(tr);
		}
	}

	function getPostes() {
		makeRequest("GET", "", function () {
			let responseJson = JSON.parse(this.responseText);
			if (this.readyState == 4 && this.status == 200) {
				postes = responseJson;
				colorirCell();
			} else {
				let rj = JSON.parse(this.responseText);
				errorHandler(rj);
			}
		});
	}

	function getConexoes() {
		makeRequest("GET", "/conexoes", function () {
			let responseJson = JSON.parse(this.responseText);
			if (this.readyState == 4 && this.status == 200) {
				conexoes = responseJson;
				conectCells();
			} else {
				let rj = JSON.parse(this.responseText);
				errorHandler(rj);
			}
		});
	}

	function getMenorCaminho(id) {
		makeRequest("GET", "/menorcaminho/" + id, function () {
			let responseJson = JSON.parse(this.responseText);
			if (this.readyState == 4 && this.status == 200) {
				caminho = responseJson;
				if (cellsCaminho) {
					for (let i = 1; i < cellsCaminho.length - 1; i++) {
						cellsCaminho[i].style.backgroundColor = "black";
					}
				}
				cellsCaminho = [];
				if (conexoesCaminho) {
					for (let i = 0; i < conexoesCaminho.length; i++) {
						document.getElementById("conx" + conexoesCaminho[i].id).style.backgroundColor = "blue";
					}
				}
				conexoesCaminho = [];
				for (let i = 0; i < caminho.length; i++) {
					cellsCaminho.push(getCellCoordenada(caminho[i]));
				}
				for (let i = 0; i < caminho.length - 1; i++) {
					
					for (let j = 0; j < conexoes.length; j++) {
						let conexao = conexaoCaminho(conexoes[j], caminho[i].id, caminho[i + 1].id);
						if (conexao) {
							conexoesCaminho.push(conexao);
						} else {
							document.getElementById("conx" + conexoes[j].id).style.backgroundColor = "white"
						}
					}
				}
				colorirCaminho();
			} else {
				let rj = JSON.parse(this.responseText);
				errorHandler(rj);
			}
		});
	}

	function colorirCaminho() {
		p = caminho[caminho.length - 1];
		if (destino != p) {
			if (destino)
				getCellCoordenada(destino).style.backgroundColor = "black";
			destino = p;
		}
		getCellCoordenada(destino).style.backgroundColor = "blue";
		for (let i = 1; i < cellsCaminho.length - 1; i++) {
			cellsCaminho[i].style.backgroundColor = "yellow";
		}
		for (let i = 0; i < conexoesCaminho.length; i++) {
			document.getElementById("conx" + conexoesCaminho[i].id).style.backgroundColor = "red"
		}

	}

	function conexaoCaminho(conexao, posteId1, posteId2) {
		if (conexao.origem.id == posteId1 && conexao.destino.id == posteId2
			|| conexao.origem.id == posteId2 && conexao.destino.id == posteId1) {
			return conexao;
		}
		return false;
	}

	function makeRequest(method, url, onloadend, data) {
		let xhr = new XMLHttpRequest();
		xhr.open(method, "http://localhost:8080/postes" + url, true);
		xhr.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
		if (data) {
			xhr.send(JSON.stringify(data));
		} else {
			xhr.send();
		}
		xhr.onloadend = onloadend;
	}
</script>

</html>